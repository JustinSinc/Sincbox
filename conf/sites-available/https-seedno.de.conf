# upstream backends for laptop
upstream laptop {
	server 10.25.0.3;
	server 192.168.1.10 backup;
}

# upstream backends for desktop
upstream desktop {
	server 10.25.0.6;
}

# listen for requests to https://seedno.de/
server {
	server_name seedno.de;
	include /etc/nginx/conf.d/shared.conf;

	# enable http strict transport security (hsts)
	add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

	# enable LetsEncrypt SSL certs
	ssl_certificate /etc/letsencrypt/live/seedno.de/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/seedno.de/privkey.pem;

	# set root directory
	root /var/www/html/seedno.de;

	# unavailable upstream results in 502 error
	proxy_next_upstream error timeout http_502;

	# try serving files locally; if they don't exist, serve landing page
	location / {
		# hide .html extension
		rewrite ^(/.*)\.html(\?.*)?$ $1$2 permanent;
			
		# hide trailing slash
		rewrite ^/(.*)/$ /$1 permanent;
			
		# serve landing page
		index index.html;

		# serve landing page, requesting html document, then uri, in that order
		# otherwise 404
		try_files $uri/index.html $uri.html $uri/ $uri =404;

		# allow caching of static files
		expires max;
	}

	location /laptop {
		proxy_pass http://laptop/;
	}

	location /desktop {
		proxy_pass http://desktop/;
	}

	location /stats/ {
		# hide .html extension
		rewrite ^(/.*)\.html(\?.*)?$ $1$2 permanent;

		# serve landing page, requesting html document, then uri, in that order
		# otherwise 404
		try_files $uri.html $uri/ $uri =404;

		# enable fancy indexing
		fancyindex on;
		fancyindex_exact_size off;
		fancyindex_ignore .png;
	}	
	
	location /try/ {
		# pass requests to docker container demo
		proxy_pass http://try-backend/;

		# security headers
		add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
		add_header X-Frame-Options DENY;
		add_header X-Content-Type-Options nosniff;
		add_header X-XSS-Protection "1; mode=block";
		add_header Content-Security-Policy "default-src https://seedno.de; connect-src wss://seedno.de/try/ws; style-src 'unsafe-inline'; media-src 'self' data:";
		add_header Referrer-Policy "strict-origin";
		add_header Feature-Policy "geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; speaker 'self'; fullscreen 'self'; payment 'none'";
			
		# gotty proxying support
		proxy_buffering off;
		proxy_redirect default;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "Upgrade";
		proxy_set_header Host $http_host;
		proxy_cache_bypass $http_upgrade;

		# disable caches
		expires 0;

		# honour the fallen
		add_header X-Clacks-Overhead "GNU Terry Pratchett" always;	
	}

	location /watch/ {
		# pass requests to terminal broadcast
		proxy_pass http://watch-backend/;

		# security headers
		add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
		add_header X-Frame-Options DENY;
		add_header X-Content-Type-Options nosniff;
		add_header X-XSS-Protection "1; mode=block";
		add_header Content-Security-Policy "default-src https://seedno.de; connect-src wss://seedno.de/watch/ws; style-src https://seedno.de 'unsafe-inline'; media-src 'self' data:";
		add_header Referrer-Policy "strict-origin";
		add_header Feature-Policy "geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; speaker 'self'; fullscreen 'self'; payment 'none'";

		# gotty proxying support
		proxy_buffering off;
		proxy_redirect default;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "Upgrade";
		proxy_set_header Host $http_host;
		proxy_cache_bypass $http_upgrade;

		# disable caches
		expires 0;

		# honour the fallen
		add_header X-Clacks-Overhead "GNU Terry Pratchett" always;
	}

	location /_files/ {
		rewrite ^/(.*)$ https://seedno.de/gentoo/$1 redirect;
        }
}
