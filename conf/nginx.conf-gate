## /etc/nginx/nginx.conf
# a basic nginx config file for my personal site
##  example certbot command to generate dhparams and letsencrypt certs for this site
# $ sudo openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
# $ wget https://dl.eff.org/certbot-auto && chmod a+x certbot-auto

# run nginx as the www-data user
user www-data;

# set the number of workers equal to the cpu count
worker_processes auto;

# set the pid file location
pid /run/nginx.pid;

# set the maximum number of simultaneous connections
# since this is a proxy server, this is set higher than default
events {
	worker_connections 2048;
}

# configuration for the webserver itself
http {
	# use proxy errors instead of backend
	proxy_intercept_errors on;

	# limit simultaneous connections to protect against slowloris attacks
	limit_conn_zone $binary_remote_addr zone=addr:10m;
	limit_conn addr 64;

	# cache by hostname and uri pair
	proxy_cache_key "$scheme$request_method$host$request_uri";

	# only cache these http methods
	proxy_cache_methods GET HEAD;

	# include upstream servers from file
	include /etc/nginx/conf.d/upstream.conf;

	# extend proxy timeout time to prevent issues with proxied websockets connections
	proxy_read_timeout 120s;
	proxy_send_timeout 120s;

	# tell nginx what sort of content we'll be displaying
	include mime.types;
	default_type application/octet-stream;
	sendfile on;

	# set the default index file
	index index.html;

	# redirect all non-HTTPS requests to HTTPS
	server {
		listen 80;
		listen [::]:80;
		server_name a.shitposter.io shitposter.io justinsinkula.com blaming.me stop.blaming.me znc.shitposter.io frozenbutthang.com cdn.seedno.de unifi.seedno.de;
		
		# rewrite url
		return 301 https://$host$request_uri;
	}

	# redirect http://seednode.co/ to https://seedno.de/
	server {
		listen 80;
		listen [::]:80;
		server_name seednode.co seedno.de;

		# rewrite url
		return 301 https://seedno.de/;
	}

	# redirect http://cdn.seednode.co/ to https://cdn.seedno.de/
	server {
		listen 80;
		listen [::]:80;
		server_name cdn.seednode.co;

		# rewrite url
		return 301 https://cdn.seedno.de$request_uri;
	}

	# redirect http://unifi.seednode.co/ to https://unifi.seedno.de/
	server {
		listen 80;
		listen [::]:80;
		server_name unifi.seednode.co;

		# rewrite url
		return 301 https://unifi.seedno.de$request_uri;
	}

	# redirect https://unifi.seednode.co/ to https://unifi.seedno.de/
	server {
		server_name unifi.seednode.co;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/unifi.seednode.co/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/unifi.seednode.co/privkey.pem;

		# rewrite url
		return 301 https://unifi.seedno.de$request_uri;
	}

	# redirect https://seednode.co/ to https://seedno.de/
	server {
		server_name seednode.co;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/seednode.co/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/seednode.co/privkey.pem;

		# rewrite url
		return 301 https://seedno.de$request_uri;
	}

	# listen for requests to https://seedno.de/
	server {
		server_name seedno.de;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/seedno.de/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/seedno.de/privkey.pem;

		# try serving files locally; if they don't exist, serve landing page
		location / {
			# hide .html extension
			rewrite ^(/.*)\.html(\?.*)?$ $1$2 permanent;
			
			# hide trailing slash
			rewrite ^/(.*)/$ /$1 permanent;
			
			# serve landing page
			index index.html;

			# serve landing page, requesting html document, then uri, in that order
			# otherwise 404
			try_files $uri/index.html $uri.html $uri/ $uri =404;

			# serve files from local web directory
			root /var/www/html/seedno.de;

			# allow caching of static files
			expires max;
		}

		location /stats/ {
			# require credentials
			auth_basic "You shall not pass!";
			auth_basic_user_file .htpasswd.stats;

			# hide .html extension
			rewrite ^(/.*)\.html(\?.*)?$ $1$2 permanent;

			# serve landing page, requesting html document, then uri, in that order
			# otherwise 404
			try_files $uri.html $uri/ $uri =404;

			# serve files from local web directory
			root /var/www/html;

			# enable fancy indexing
			fancyindex on;
			fancyindex_exact_size off;
			fancyindex_ignore .png;
		}	

		location /try/ {
			# pass requests to docker container demo
			proxy_pass http://try-backend/;

			# security headers
			add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header X-XSS-Protection "1; mode=block";
			add_header Content-Security-Policy "default-src https://seedno.de; connect-src wss://seedno.de/try/ws; style-src 'unsafe-inline'; media-src 'self' data:";
			add_header Referrer-Policy "strict-origin";
			add_header Feature-Policy "geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; speaker 'self'; fullscreen 'self'; payment 'none'";
			
			# gotty proxying support
			proxy_buffering off;
			proxy_redirect default;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_cache_bypass $http_upgrade;

			# disable caches
			expires 0;

			# honour the fallen
			add_header X-Clacks-Overhead "GNU Terry Pratchett" always;	
		}

		location /watch/ {
			# pass requests to terminal broadcast
			proxy_pass http://watch-backend/;

			# security headers
			add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header X-XSS-Protection "1; mode=block";
			add_header Content-Security-Policy "default-src https://seedno.de; connect-src wss://seedno.de/watch/ws; style-src https://seedno.de 'unsafe-inline'; media-src 'self' data:";
			add_header Referrer-Policy "strict-origin";
			add_header Feature-Policy "geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; speaker 'self'; fullscreen 'self'; payment 'none'";

			# gotty proxying support
			proxy_buffering off;
			proxy_redirect default;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_cache_bypass $http_upgrade;

			# disable caches
			expires 0;

			# honour the fallen
			add_header X-Clacks-Overhead "GNU Terry Pratchett" always;
		}
	}

	# listen for requests to https://unifi.seedno.de/
	server {
		server_name unifi.seedno.de;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/unifi.seedno.de/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/unifi.seedno.de/privkey.pem;

		# forward to unifi controller
		return 301 https://unifi.seedno.de:8443/;
	}	

	# listen for requests to https://a.shitposter.io/
	server {
		server_name a.shitposter.io;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/a.shitposter.io/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/a.shitposter.io/privkey.pem;

		# enable fancy indexing
		fancyindex on;
		fancyindex_exact_size off;

		# set root directory
		root /var/www/html/a.shitposter.io;

		location / {
			# require login
			auth_basic "Restricted access";
			auth_basic_user_file /etc/nginx/.htpasswd;
		}
	}

	# listen for requests to https://frozenbutthang.com/
	server {
		server_name frozenbutthang.com;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/frozenbutthang.com/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/frozenbutthang.com/privkey.pem;

		# set root directory
		root /var/www/html/frozenbutthang.com;

		location = / {
			# hide .html extension
			rewrite ^(/.*)\.html(\?.*)?$ $1$2 permanent;

			# serve landing page
			index index.html;

			# serve landing page, requested html document, then uri in that order
			# otherwise 404
			try_files $uri/index.html $uri.html $uri/ $uri =404;

			# allow caching of static files
			expires max;
		}
	}

	# listen for requests to https://shitposter.io/
	server {
		server_name shitposter.io;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/shitposter.io/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/shitposter.io/privkey.pem;

		# set root directory
		root /var/www/html/shitposter.io;
	}

	# listen for requests to https://justinsinkula.com/
	server {
		server_name justinsinkula.com;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/justinsinkula.com/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/justinsinkula.com/privkey.pem;

		# set root directory
		root /var/www/html/justinsinkula.com;

		location /pics/ {
			# require login
			auth_basic "Restricted access";
			auth_basic_user_file /etc/nginx/.htpasswd_photos;
		}
	}
	
	# redirect https://stop.blaming.me/ to https://blaming.me/
	server {
		server_name stop.blaming.me;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/stop.blaming.me/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/stop.blaming.me/privkey.pem;

		# redirect to blaming.me
		return 301 https://blaming.me$request_uri;
	}

	# listen for requests to https://blaming.me/
	server {
		server_name blaming.me;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/blaming.me/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/blaming.me/privkey.pem;

		# set root directory
		root /var/www/html/blaming.me;

		location / {
			# pass requests to terminal broadcast
			proxy_pass http://watch-backend/;

			# websockets support
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_cache_bypass $http_upgrade;

			# disable proxy buffering
			proxy_buffering off;
			proxy_redirect default;

			# disable caches
			expires 0;

			# a man is not dead while his name is still spoken
			add_header X-Clacks-Overhead "GNU Terry Pratchett" always;
		}

		location /df/ {
			# redirect to dwarf fortress server
			proxy_pass http://df-backend/;

			# websockets support
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_cache_bypass $http_upgrade;

			# disable proxy buffering
			proxy_buffering off;
			proxy_redirect default;

			# disable caches
			expires 0;

			# a man is not dead while his name is still spoken
			add_header X-Clacks-Overhead "GNU Terry Pratchett" always;
		}
	}

	# redirect https://cdn.seednode.co/ to https://cdn.seedno.de/
	server {
		server_name cdn.seednode.co;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/cdn.seednode.co/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/cdn.seednode.co/privkey.pem;

		# redirect to blaming.me
		return 301 https://cdn.seedno.de$request_uri;
	}

	# listen for requests to https://cdn.seedno.de/
	server {
		server_name cdn.seedno.de;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/cdn.seedno.de/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/cdn.seedno.de/privkey.pem;
		
		# set root directory
		root /var/www/html/cdn.seedno.de;

		# these file types are typically static and can be cached long-term
		location ~* \.(?:jpg|jpeg|gif|png|ico|gz|svg|svgz|mp4|ogg|ogv|webm|pdf)$ {
			expires 30d;
			add_header Cache-Control "public";
		}

		# enable fancy indexing
		fancyindex on;
		fancyindex_exact_size off;
		fancyindex_ignore ^z$ ^error.html$ ^majora.png$ ^favicon.ico$ ^robots.txt$ ^pics$;
		
		# serve files located in /
		location / {
			# First attempt to serve request as file, then
			# as directory, then fall back to displaying a 404.
			try_files $uri $uri/index.html $uri.html $uri/ =404;
		}

		# serve all files in /txt/ as plain text
		location /txt/ {
			default_type text/plain;
		}

		# append trailing slash to /pics/ if needed
		location ~ /pics {
			rewrite ^([^.\?]*[^/])$ $1/ permanent;
		}
	}

	# listen for requests to http://old.blaming.me/
	server {		
		# listen on both ipv4 and ipv6
		listen 80;
		listen [::]:80;
				
		server_name old.blaming.me;

		# disable gzip to prevent CRIME and other side-channel attacks
		gzip off;

		# set root directory
		root /var/www/html/cdn.seedno.de/pics;

		# disable access logging
		access_log off;

		# error pages
		error_page 404 502 503 504 /error.html;

		location = /error.html {
			internal;
		}

		# these file types are typically static and can be cached long-term
		location ~* \.(?:jpg|jpeg|gif|png|ico|gz|svg|svgz|mp4|ogg|ogv|webm|pdf)$ {
			expires 30d;
			add_header Cache-Control "public";
		}

		# serve files located in /
		location / {
			# First attempt to serve request as file, then
			# as directory, then fall back to displaying a 404.
			try_files $uri $uri/index.html $uri.html $uri/ =404;
		}
	}

	# listen for requests to http://keep.blaming.me/
	server {
		# listen on ipv4 only
		listen 80;

		server_name keep.blaming.me;

		# disable gzip to prevent CRIME and other side-channel attacks
		gzip off;

		# set root directory
		root /var/www/html/keep.blaming.me;
	
		# disable access logging
		access_log off;
	}		

	# listen to requests for https://znc.shitposter.io/
	server {
		server_name znc.shitposter.io;
		include /etc/nginx/conf.d/shared.conf;

		# enable LetsEncrypt SSL certs
		ssl_certificate /etc/letsencrypt/live/znc.shitposter.io/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/znc.shitposter.io/privkey.pem;

		# forward requests to znc webadmin
		location / {
			# require login auth_basic "Restricted access"; 
			auth_basic_user_file /etc/nginx/.htpasswd;
			
			# pass requests to znc webadmin
			proxy_pass https://127.0.0.1:1337/;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		}
	}		
}
